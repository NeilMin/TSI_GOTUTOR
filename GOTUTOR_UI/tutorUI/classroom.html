<!DOCTYPE HTML>
<html lang="en">
<head>
    <link href="styles.css" rel="stylesheet">
    <title>GoTutor!</title>
    <script src="https://apis.google.com/js/platform.js"></script>
    <!-- full Calendar import -->
    <link href='https://unpkg.com/@fullcalendar/core@4.4.0/main.min.css' rel='stylesheet'/>
    <link href='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.css' rel='stylesheet'/>
    <link href='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.min.css' rel='stylesheet'/>
    <script src='https://unpkg.com/@fullcalendar/core@4.4.0/main.js'></script>
    <script src='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.js'></script>
    <script src='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.js'></script>

    <!-- socket.io imports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
    <script src="auth.js"></script>

</head>


<script>
    //TODO: Configure calendar in such a way: Add office hour, remove by clicking on it and pressing remove button
    //connect web socket for communicating reservation made by this user and other user
    var socket;
    //mapping time slot status to color

    //view->controller
    function reserveAppointment(officeHourId, question) {
        socket.emit('reserve', {id: officeHourId, question: question});
    }

    //controller->view
    //listen for new reservation from other users
    function initPeerListener(calendar) {
        socket = io.connect('http://gotutor.com');
        socket.on('new', markOccupied)
    }

    //Translate REST API response to the format accepted by full calendar api
    function transformEvent(info) {
        //info.event.setProp("backgroundColor",colorMap.get(info.event.extendedProps.available))
        info.backgroundColor = colorMap.get(info.available);
        console.log(info)
    }

    //view
    var calendar;

    function removeOfficeHour(event) {
        var prompt = document.createElement("div");
        var submit = document.createElement("button");
        var submitText = document.createElement("p");
        submitText.textContent = "Remove office hour";
        submit.appendChild(submitText);
        submit.onclick = function () {
            //TODO: Remove OH
        };
        prompt.appendChild(submit);

        //Prevent repetitive attachment of frames
        prompt.onclick = function (e) {
            e.stopPropagation();
        };

        return prompt;
    }

    document.addEventListener('DOMContentLoaded', function () {
        //The ID of element to put calendar is 'cal'
        var calendarEl = document.getElementById('cal');

        //Initialize calendar
        calendar = new FullCalendar.Calendar(calendarEl, {
            events: '/fetchOfficeHours',
            plugins: ['timeGrid'],
            eventClick: function (eventClickInfo) {
                eventClickInfo.el.appendChild(removeOfficeHour(eventClickInfo.event));
            },

            eventDataTransform: transformEvent,
            //eventSourceSuccess: initPeerListener(calendar, markOccupied),
            defaultView: 'timeGridWeek',
            header: false
        });


        calendar.render();
    });
</script>

<script>
    function modifyTutor(e){
        var valid=[]
        var invalid=[]
        document.getElementById('tutorList').value.split('\n').forEach(function (e) {
            if (e.endsWith("@ucsd.edu")) {
                valid.push(e.substr(0,e.search("@")))
            }else{
                invalid.push(e)
            }
        })
        fetch('/alterTutor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(valid),
        })
    }
</script>
<body>
<div class="bg-main">
    <div class="container">
        <nav>
            <img src="images/GoTutor.png" alt="logo" class="logo">
            <!--TODO: Classroom navigation-->
            <ul class="navigation">
                <li><a href="writeup.html">Assignment</a></li>
                <li><a href="classroom.html">Classroom</a></li>
                <li><a href="appointment.html">Appointments</a></li>
                <li><a href="forum.html">Forum</a></li>
                <li><a href="tutor.html">Tutors</a></li>
                <li><a href="setting.html">Settings</a></li>
                <li><a href="help.html">Help</a></li>
                <li><a href="#" onclick="signOut();">Logout</a></li>
            </ul>
        </nav>
        <div class="content">
            <h1>Classroom Office Hours</h1>
            <div id="cal"></div>
                <p>Upload student spreadsheet</p>
                <textarea id="tutorList" rows="5"></textarea>
                <button onclick="modifyTutor();">set as tutor</button>
        </div>
    </div>
</div>
</body>
