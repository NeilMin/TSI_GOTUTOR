<!DOCTYPE HTML>
<html lang="en">
<head>
    <link href="styles.css" rel="stylesheet">
    <title>GoTutor!</title>
    <script src="https://apis.google.com/js/platform.js"></script>

    <!-- full Calendar import -->
    <link href='https://unpkg.com/@fullcalendar/core@4.4.0/main.min.css' rel='stylesheet'/>
    <link href='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.css' rel='stylesheet'/>
    <link href='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.min.css' rel='stylesheet'/>
    <script src='https://unpkg.com/@fullcalendar/core@4.4.0/main.js'></script>
    <script src='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.js'></script>
    <script src='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.js'></script>
    <script src="https://unpkg.com/@fullcalendar/interaction@4.4.0/main.js"></script>
    <!-- socket.io imports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
    <!--TODO: Export this as a POST for better design-->
    <script>
        //connect web socket for communicating reservation made by this user and other user
        var socket;
        //mapping time slot status to color
        const colorMap = new Map([["yes", "green"],["yes-me", "yellow"], ["no", "red"], ["me", "blue"],["changed","purple"],['deleted','grey'],['new','#ADD8E6']]);

        //view->controller
        
        //view
        var calendar;
        var newEventIds=new Set();
        var changedEventIds=new Set();
        var removedEventIds=new Set();
        
        function setColor(event){
            var modFlag=event.extendedProps.modified;
            if (!modFlag) {
                event.setProp("backgroundColor", colorMap.get(event.extendedProps.available));
            }
            else if (modFlag&1) {
                event.setProp("backgroundColor", colorMap.get("new"));
            }
            else if (modFlag&2){
                event.setProp("backgroundColor", colorMap.get("changed"));
            }
            else if (modFlag&4){
                event.setProp("backgroundColor", colorMap.get("deleted"));
            }
        }
        function markOccupied(officeHourId) {
            var toModify = calendar.getEventById(officeHourId);
            if (toModify.extendedProps.available=="yes-me") {
                toModify.setDate(toModify.extendedProps.oriStart,toModify.extendedProps.oriEnd);
                toModify.setExtendedProp("available","me")
                toModify.setExtendedProp("modified",0)
                changedEventIds.delete(officeHourId);
                removedEventIds.delete(officeHourId);
            }else{
            toModify.setExtendedProp("available", "no");
            }
            setColor(toModify);
        }
        
        function handleEventDrag(eventDropInfo){
            var eventId=eventDropInfo.event.id
            if(!newEventIds.has(eventId)){
                changedEventIds.add(eventId);
            }
            removedEventIds.delete(eventId);
            eventDropInfo.event.setExtendedProp('modified',eventDropInfo.event.extendedProps.modified|2);
        }
        
        function handleDateSelect(selectionInfo){
            var eventId=calendar.addEvent({
                title:"new office hour",
                start:selectionInfo.start,
                end:selectionInfo.end,
                backgroundColor:colorMap.get("new"),
                modified:1,
                available:"yes-me"
            })
            newEventIds.add(eventId);
        }
        
        
        function initCalendar(events) {
            //The ID of element to put calendar is 'cal'
            var calendarEl = document.getElementById('cal');
            var start=new Date()
            var end=new Date()
            end.setDate(end.getDate()+6)
            //Initialize calendar
            calendar = new FullCalendar.Calendar(calendarEl, {
                events: events,
                plugins: ['timeGrid','interaction' ],
                eventDrop: handleEventDrag,
                eventResize:handleEventDrag,
                selectable: true,
                selectMirror:true,
                select:handleDateSelect,
                defaultView: 'timeGrid',
                eventResizableFromStart:true,
                modified:0,
                visibleRange:{start:start,end:end},
                header: false
            });
            calendar.render();
        }
        //controller->view
        //listen for new reservation from other users
        function initPeerListener() {
            socket = io.connect('http://gotutor.com/appointments');
            socket.on('new', markOccupied)
        }
        function transformResponse(content) {
            var uid=content.uid;
            var events=content.available.map(e=>(
                {
                    start:e.start*1000,
                    end:e.end*1000,
                    oriStart:e.start*1000,
                    oriEnd:e.end*1000,
                    title:e.tutor,
                    id:e.id,
                    available:e.tutor==uid?"yes-me":"yes",
                    editable:e.tutor==uid,
                    eventResizableFromStart:true
                }
            ))
            var myAppointments=new Map()
            content.myAppointments.forEach(e => {
                myAppointments.set(e.officeHourId,{id:e.id,description:e.description});
            });
            content.unavailable.forEach(e=>{
                e={
                    start:e.start*1000,
                    end:e.end*1000,
                    title:e.tutor,
                    id:e.id,
                    editable:false
                }
                var appointment=myAppointments.get(e.id)
                if (appointment){
                    e.available='me'
                    e.appointmentId=appointment.id;
                    e.appointmentDescription=appointment.description;
                }else{
                    e.available='no'
                }
                events.push(e);
            })
//            initPeerListener()
            events.forEach(e=>{e.backgroundColor=colorMap.get(e.available)});
            return events;
        }
        
        var initEvents=fetch("/fetchAppointments").then(res=>res.json()).then(r=>transformResponse(r))

        document.addEventListener('DOMContentLoaded', function () {
            initEvents.then(r=>{
                initCalendar(r);
                initPeerListener();
            })
        });

    </script>
</head>

<body>
<div class="bg-main">
    <div class="container">
        <nav>
            <img src="images/GoTutor.png" alt="logo" class="logo">
            <!--TODO: Classroom navigation-->
            <ul class="navigation">
                <li><a href="writeup.html">Assignment</a></li>
                <li><a href="classroom.html">Classroom</a></li>
                <li style="color: #F3E500;">Appointments</li>
                <li><a href="forum.html">Forum</a></li>
                <li><a href="tutor.html">Tutors</a></li>
                <li><a href="ticket.html">Tickets</a></li>
                <li><a href="setting.html">Settings</a></li>
                <li><a href="help.html">Help</a></li>
                <li><a href="#" onclick="signOut();">Logout</a></li>
            </ul>
        </nav>
        <div class="content">
            <div id="cal"></div>
            <table id="acceptedAppointment">
                Accepted appointments
                <tr>
                    <th>Number</th>
                    <th>Student name</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Problem</th>
                    <th>Submission date</th>
                    <th>Submission time</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>01</td>
                    <td>Smith</td>
                    <td>0407</td>
                    <td>1200</td>
                    <td>Installation problem</td>
                    <td>0514</td>
                    <td>1924</td>
                    <td>Approved</td>
                </tr>
            </table>
            <br/>
            <form id="cancelAppointment">
                <label>Cancel appointments</label>
                <select id="acceptedAppointmentList">
                    <option value="1">one</option>
                    <option value="2">two</option>
                    <option value="3">three</option>
                    <option value="4">four</option>
                </select>
                <button id="cancel">Cancel</button>
            </form>
            <br/>
            <table id="futureAppointment">
                Future appointments
                <tr>
                    <th>Number</th>
                    <th>Student name</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Problem</th>
                    <th>Submission date</th>
                    <th>Submission time</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>01</td>
                    <td>Smith</td>
                    <td>0407</td>
                    <td>1200</td>
                    <td>Installation problem</td>
                    <td>0514</td>
                    <td>1924</td>
                    <td>Pending</td>
                </tr>
            </table>
            <br/>
            <label>Select an appointment</label>
            <select id="futureAppointmentList">
                <option value="1">one</option>
                <option value="2">two</option>
                <option value="3">three</option>
                <option value="4">four</option>
            </select>
            <button id="Approve">Approve</button>
            <button id="Decline">Decline</button>
            <br/>
            <br/>
            <table id="pastAppointment">
                Past appointments
                <tr>
                    <th>Number</th>
                    <th>Student name</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Problem</th>
                    <th>Submission date</th>
                    <th>Submission time</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>01</td>
                    <td>Smith</td>
                    <td>0407</td>
                    <td>1200</td>
                    <td>Installation problem</td>
                    <td>0514</td>
                    <td>1925</td>
                    <td>Declined/Approved</td>
                </tr>
            </table>
            <br/>
            <label>Select an appointment</label>
            <select id="pastAppointmentList">
                <option value="1">one</option>
                <option value="2">two</option>
                <option value="3">three</option>
                <option value="4">four</option>
            </select>
            <button id="requestFeedback">Request feedback</button>
        </div>
    </div>
</div>
</div>
</body>
